version: "3.9"

services:
  web:
    container_name: backend
    image: "${WEB_IMAGE}"
    # command: gunicorn server.wsgi:application --bind 0.0.0.0:8000 -w 17
    command: gunicorn server.asgi:application --bind 0.0.0.0:8000 -w 17 -k uvicorn.workers.UvicornWorker
    volumes:
      - django_static_volume:/usr/src/app/static
      - media:/usr/src/app/media
    env_file: .env


  react:
    container_name: frontend
    image: "${FRONTEND_IMAGE}"
    volumes:
      - react_static_volume:/usr/src/app/build/static
    depends_on:
      - web
    env_file:
      - .env

  tensorflow-servings:
    container_name: tensorflow_serving
    image: "${TENSORFLOW_IMAGE}"
    depends_on:
      - web

  nginx:
    container_name: nginx
    restart: always
    image: "${NGINX_IMAGE}"
    volumes:
      - django_static_volume:/usr/src/app/django_files/static
      - react_static_volume:/usr/src/app/react_files/static
      - media:/usr/src/app/media
    sysctls:
      net.ipv4.ip_local_port_range: "1024 65535"
      net.ipv4.tcp_tw_reuse: "1"
      net.ipv4.tcp_fin_timeout: "15"
      net.core.somaxconn: "4096"
      net.ipv4.tcp_max_syn_backlog: "20480"
      net.ipv4.tcp_max_tw_buckets: "400000"
      net.ipv4.tcp_no_metrics_save: "1"
      net.ipv4.tcp_rmem: "4096 87380 16777216"
      net.ipv4.tcp_syn_retries: "2"
      net.ipv4.tcp_synack_retries: "2"
      net.ipv4.tcp_wmem: "4096 65536 16777216"
    ports:
      - "80:80"
    depends_on:
      - web
      - react

  redis:
    container_name: redis
    image: "redis:alpine"

  celery:
    container_name: celery
    image: "${CELERY_IMAGE}"
    command: celery -A server worker -l info -Ofair — without-gossip — without-mingle — without-heartbeat
    #command: celery -A server worker -l info -Ofair  -P eventlet -c 1000 — without-gossip — without-mingle — without-heartbeat
    volumes:
      - django_static_volume:/usr/src/app/static
      - media:/usr/src/app/media
    env_file:
      - .env
    depends_on:
      - redis

volumes:
  postgres_data:
  django_static_volume:
  react_static_volume:
  media:
